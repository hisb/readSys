
<!DOCTYPE html>
<html class="no-js">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title></title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      

      <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
      <link rel="shortcut icon" href="favicon.ico">
      <!-- Google Fonts -->
      <link href='http://fonts.googleapis.com/css?family=Playfair+Display:400,700,400italic|Roboto:400,300,700' rel='stylesheet' type='text/css'>
      <!-- Animate -->
      <link rel="stylesheet" href="stylesheets/animate.css">
      <!-- Icomoon -->
      <link rel="stylesheet" href="stylesheets/icomoon.css">
      <!-- Bootstrap  -->
      <link rel="stylesheet" href="stylesheets/bootstrap.min.css">

      <link rel="stylesheet" href="stylesheets/style2.css">

      <link rel="stylesheet" href="stylesheets/detail.css">


      <!-- Modernizr JS -->
      <script src="javascripts/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    </head>
    <body>
        <div id="fh5co-offcanvas">
            <a href="#" class="fh5co-close-offcanvas js-fh5co-close-offcanvas"><span><i class="icon-cross3"></i> <span>关闭</span></span></a>
            <div class="fh5co-bio">
              <figure>
                <img src="images/person1.jpg" alt="Free HTML5 Bootstrap Template" class="img-responsive">
              </figure>
              <h3 class="heading">About Me</h3>
                this is userINfo
            </div>

            <div class="fh5co-menu">
                <div class="fh5co-box">
                    <h3 class="heading">Categories</h3>
                    <ul>
                        <li><a href="#">Travel</a></li>
                        <li><a href="#">Style</a></li>
                        <li><a href="#">Photography</a></li>
                        <li><a href="#">Food &amp; Drinks</a></li>
                        <li><a href="#">Culture</a></li>
                    </ul>
                </div>
                <div class="fh5co-box">
                    <h3 class="heading">Search</h3>
                    <form action="#">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Type a keyword">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- END #fh5co-offcanvas -->
        <header id="fh5co-header">
            <div class="container-fluid">
                <div class="row">
                <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
                <div class="col-lg-12 col-md-12 text-center">
                  <!-- <h1 id="fh5co-logo"><a href="index.html">自在独行</a></h1> -->
                </div>
                </div>
            </div>
        </header>
        <!-- <a href="#" class="fh5co-post-prev"><span><i class="icon-chevron-left"></i> Prev</span></a>
        <a href="#" class="fh5co-post-next"><span>Next <i class="icon-chevron-right"></i></span></a> -->
        <!-- END #fh5co-header -->
        <div class="container-fluid">
            <div class="row fh5co-post-entry single-entry">
                <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0 content-detail">
                    <section class = 'col-lg-12 col-md-12'>
                        <figure class="col-lg-6 animate-box detail-head">
                            <img id = 'bookImg' src="" alt="Image" class="img-responsive">
                        </figure>
                        <figure class = 'col-lg-6 animate-box'>
                            <dl class = 'detail-card'>
                                <dt id = 'bookName'></dt>
                                <dd>
                                    <span id = 'author'></span>
                                    <span id = 'owner'></span>
                                    <span id = 'hunger'></span>
                                    <span class="fh5co-meta toHunger"><a href="/bookHunger" id = 'toHunger'>参与排队</a></span>
                                    <!-- <span class="fh5co-meta hungerStatus">排队中</span> -->
                                </dd>
                            </dl>
                        </figure>
                    </section>
                    
                    
                    <span class="col-lg-12 fh5co-meta animate-box summary"> 内容简介： </span>

                    <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                        <figure class="animate-box">
                            <legend>
                                <span>我来说一句</span>
                            </legend>
                            <ul class = 'commentList'>
                                <li>
                                    <img src = '' class = 'personImg'/>
                                    <span class = 'text'>
                                    </span>
                                </li>


                            </ul>
                            <div class = divCont>
                                <input type = 'text' class = 'commentSend' placeholder = '我来说一句' /><label id = 'submitComment'><i class = 'glyphicon glyphicon-send'></i></label>
                            </div>
                        </figure>
                    </div>
                </article>
            </div>
        </div>

        <footer id="fh5co-footer">
            <p>
                <small>&copy; 2016. Magazine Free HTML5. All Rights Reserverd. <br> More Templates <a href="http://www.cssmoban.com/" target="_blank" title="模板之家">模板之家</a> - Collect from <a href="http://www.cssmoban.com/" title="网页模板" target="_blank">网页模板</a></small>
            </p>
        </footer>

        <!-- jQuery -->
        <script src="javascripts/jquery-1.11.1.min.js"></script>
        <!-- jQuery Easing -->
        <script src="javascripts/jquery.easing.1.3.js"></script>
        <!-- Bootstrap -->
        <script src="javascripts/bootstrap.min.js"></script>
        <!-- Waypoints -->
        <script src="javascripts/jquery.waypoints.min.js"></script>
        <!-- Main JS -->
        <script src="javascripts/common.js"></script>
        <script src="javascripts/main.js"></script>

        <script>
            $(document).ready(function() {
                var bookid = getUrlParam('bookid');
                var userId;
                $.ajax({
                    url: 'detail',
                    type: 'get',
                    data: {bookid: bookid}
                }).done((data) => {
                    toJoinHtml(data);
                });

                $.ajax({
                    url: '/userInfo',
                    type: 'get'
                }).done((data) => {
                    userId = data.data._id;
                });

                $('#submitComment').on('click', function() {
                    var _this = $(this);
                    var comment = _this.prev('input').val();
                    var data = {};
                    data.bookid = bookid;
                    data.content = comment;
                    if(comment) {
                        $.ajax({
                            url: '/feelAdd',
                            type: 'post',
                            data: data
                        }).done((res) => {
                            if(res.status == 'OK') {
                                updateCommentList(res.data);
                                _this.prev('input').val('');
                            }
                        })
                    }
                })

                function updateCommentList(data) {
                    $('.commentList').append('<li><img src = "' + data.imgSrc + '" class = "personImg"/><span class = "text">' + data.usernick + '<br>' + data.content + '&ensp;' + dateToStr(new Date(data.date)) + '</span></li>');
                }

                function toJoinHtml(data) {
                    $('#bookImg').attr('src', data.imgSrc);
                    $('#bookName').text(data.title);
                    $('#author').text(data.author + ' 著');
                    $('#owner').text('由 ' + data.owner + ' 分享');
                    $('.summary').text(data.desc);
                    $('#hunger').text(hunger(data.hungers));
                    setStatus(data.hungers);
                    var commentStr = '';
                    $.each(data.feels, function(index, item) {
                        var date = dateToStr(new Date(item.cdate));
                        commentStr += '<li><img src = "' + item.imgSrc + '" class = "personImg"/><span class = "text">' + item.usernick + '<br>' + item.content + '&ensp;' + date + '</span></li>';
                    })
                    $('.commentList').html(commentStr);
                };
                function hunger(data) {
                    var html = '';
                    if(data.length == 0) {
                        html = '前面 0 人正在排队';
                    }else {
                        var hunger = [];
                        $.each(data, function(index, item) {
                            if(index < 5 && item._id !==userId) {
                                hunger.push(item.name);
                            }
                        })
                        html = hunger.join('、') + '等' + data.length + ' 人正在排队';
                    }
                    return html;
                };

                function setStatus(data) {
                    $.each(data, function(index, item) {
                        if(item._id == userId) {
                            $('#toHunger').text('放弃排队');
                        }else {
                            $('#toHunger').text('参与排队');
                        }
                    })

                }
            });
        </script>

    </body>
</html>

